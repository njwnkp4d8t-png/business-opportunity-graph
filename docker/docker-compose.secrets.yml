# Docker Compose with Secrets Support
# Use this for production or when you need secure credential management

version: '3.8'

services:
  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
    image: business-opportunity-graph:latest
    container_name: business-opportunity-graph
    restart: unless-stopped

    ports:
      - "${HOST_PORT:-8888}:8080"

    # Environment variables (non-sensitive)
    environment:
      - TZ=UTC
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DATA_DIR=/app/data
      - EXPORT_DIR=/app/exports

    # Load secrets from .env file
    env_file:
      - ../.env

    # Alternative: Use Docker secrets (for Docker Swarm)
    # secrets:
    #   - postgres_password
    #   - neo4j_password
    #   - openai_api_key

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Volumes for persistent data
    volumes:
      - ../data:/app/data:ro
      - ../exports:/app/exports
      - ../logs:/app/logs

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Security
    security_opt:
      - no-new-privileges:true

    networks:
      - app-network

  # Optional: PostgreSQL service
  # Uncomment if you want to run PostgreSQL in Docker
  # postgres:
  #   image: postgis/postgis:15-3.3
  #   container_name: business-opportunity-postgres
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_DB: ${POSTGRES_DB:-business_opportunity_graph}
  #     POSTGRES_USER: ${POSTGRES_USER:-postgres}
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
  #   ports:
  #     - "${POSTGRES_PORT:-5432}:5432"
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   networks:
  #     - app-network

  # Optional: Neo4j service
  # Uncomment if you want to run Neo4j in Docker
  # neo4j:
  #   image: neo4j:5.12
  #   container_name: business-opportunity-neo4j
  #   restart: unless-stopped
  #   environment:
  #     NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD}
  #     NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
  #   ports:
  #     - "7474:7474"  # HTTP
  #     - "7687:7687"  # Bolt
  #   volumes:
  #     - neo4j-data:/data
  #     - neo4j-logs:/logs
  #   networks:
  #     - app-network

networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Docker secrets (for Docker Swarm mode)
# secrets:
#   postgres_password:
#     file: ./secrets/postgres_password.txt
#   neo4j_password:
#     file: ./secrets/neo4j_password.txt
#   openai_api_key:
#     file: ./secrets/openai_api_key.txt

# Persistent volumes
volumes:
  postgres-data:
    driver: local
  neo4j-data:
    driver: local
  neo4j-logs:
    driver: local
